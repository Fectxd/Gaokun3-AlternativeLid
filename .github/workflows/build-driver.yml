name: Build ARM64 Driver

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Install Windows Driver Kit (WDK)
      shell: powershell
      run: |
        Write-Host "Downloading WDK installer..." -ForegroundColor Cyan

        # Download WDK installer directly
        $wdkUrl = "https://download.microsoft.com/download/3/5/7/3575914a-6f0e-4fdc-9f93-05488c867e63/wdk/wdksetup.exe"
        $installerPath = "$env:TEMP\wdksetup.exe"

        # Use curl (available on Windows)
        curl.exe -L -o $installerPath $wdkUrl

        if (-not (Test-Path $installerPath)) {
          Write-Host "[ERROR] Failed to download WDK installer" -ForegroundColor Red
          exit 1
        }

        Write-Host "Downloaded: $installerPath" -ForegroundColor Green
        Write-Host "File size: $([Math]::Round((Get-Item $installerPath).Length / 1MB, 2)) MB" -ForegroundColor Gray

        Write-Host ""
        Write-Host "Installing WDK (this may take 10-15 minutes)..." -ForegroundColor Cyan

        # Install WDK silently with features
        $arguments = @(
          "/features", "+",
          "/quiet",
          "/norestart"
        )

        $process = Start-Process -FilePath $installerPath -ArgumentList $arguments -Wait -PassThru -NoNewWindow

        if ($process.ExitCode -eq 0) {
          Write-Host "[OK] WDK installation completed successfully" -ForegroundColor Green
        } elseif ($process.ExitCode -eq 3010) {
          Write-Host "[OK] WDK installation completed (restart required, but continuing)" -ForegroundColor Yellow
        } else {
          Write-Host "[ERROR] WDK installation failed with exit code: $($process.ExitCode)" -ForegroundColor Red
          exit 1
        }

    - name: Verify WDK Installation
      shell: powershell
      run: |
        Write-Host "Verifying WDK installation..." -ForegroundColor Cyan

        $wdkPath = "C:\Program Files (x86)\Windows Kits\10"

        # List all directories in Windows Kits
        Write-Host "Checking Windows Kits directory..." -ForegroundColor Yellow
        if (Test-Path $wdkPath) {
          Write-Host "Contents of $wdkPath`:" -ForegroundColor Gray
          Get-ChildItem $wdkPath -Directory | ForEach-Object { Write-Host "  - $($_.Name)" -ForegroundColor Gray }
        }

        Write-Host ""

        if (Test-Path "$wdkPath\Include") {
          $sdkVersions = Get-ChildItem "$wdkPath\Include" -Directory | Sort-Object Name -Descending

          if ($sdkVersions.Count -gt 0) {
            Write-Host "Available SDK versions:" -ForegroundColor Cyan
            foreach ($sdk in $sdkVersions) {
              Write-Host "  - $($sdk.Name)" -ForegroundColor Gray

              # Check for km directory
              $kmPath = Join-Path $sdk.FullName "km"
              if (Test-Path $kmPath) {
                Write-Host "    [OK] km directory exists" -ForegroundColor Green

                # Check for key headers
                $ntddk = Join-Path $kmPath "ntddk.h"
                $wdf = Join-Path $kmPath "wdf.h"

                if (Test-Path $ntddk) {
                  Write-Host "    [OK] ntddk.h found" -ForegroundColor Green
                }
                if (Test-Path $wdf) {
                  Write-Host "    [OK] wdf.h found" -ForegroundColor Green
                }
              } else {
                Write-Host "    [WARN] km directory not found" -ForegroundColor Yellow
              }
            }

            # Select latest SDK with km directory
            $validSdk = $null
            foreach ($sdk in $sdkVersions) {
              $kmPath = Join-Path $sdk.FullName "km\ntddk.h"
              if (Test-Path $kmPath) {
                $validSdk = $sdk.Name
                break
              }
            }

            if ($validSdk) {
              Write-Host ""
              Write-Host "[OK] WDK is properly installed with SDK version: $validSdk" -ForegroundColor Green
            } else {
              Write-Host ""
              Write-Host "[ERROR] No valid WDK SDK found with kernel mode headers" -ForegroundColor Red
              exit 1
            }
          } else {
            Write-Host "[ERROR] No SDK versions found" -ForegroundColor Red
            exit 1
          }
        } else {
          Write-Host "[ERROR] WDK Include directory not found" -ForegroundColor Red
          exit 1
        }

    - name: Build ARM64 Driver
      shell: powershell
      run: |
        Write-Host "Building SimpleLidDriver for ARM64..." -ForegroundColor Cyan

        cd SimpleLidDriver

        # Find MSBuild using vswhere
        $vsWhere = "C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe"

        if (Test-Path $vsWhere) {
          $vsPath = & $vsWhere -latest -products * -requires Microsoft.Component.MSBuild -property installationPath
          $msbuild = Join-Path $vsPath "MSBuild\Current\Bin\MSBuild.exe"

          if (-not (Test-Path $msbuild)) {
            Write-Host "[ERROR] MSBuild not found at: $msbuild" -ForegroundColor Red
            exit 1
          }
        } else {
          Write-Host "[ERROR] vswhere.exe not found" -ForegroundColor Red
          exit 1
        }

        Write-Host "Using MSBuild: $msbuild" -ForegroundColor Gray
        Write-Host ""

        # Build with normal verbosity
        & $msbuild SimpleLidDriver.vcxproj `
          /p:Configuration=Release `
          /p:Platform=ARM64 `
          /v:normal

        if ($LASTEXITCODE -ne 0) {
          Write-Host ""
          Write-Host "[ERROR] Build failed with exit code: $LASTEXITCODE" -ForegroundColor Red
          exit $LASTEXITCODE
        }

        Write-Host ""
        Write-Host "[SUCCESS] Build completed!" -ForegroundColor Green

    - name: Verify Build Output
      shell: powershell
      run: |
        cd SimpleLidDriver

        $sysFile = "ARM64\Release\SimpleLidDriver.sys"

        if (Test-Path $sysFile) {
          $size = [Math]::Round((Get-Item $sysFile).Length / 1KB, 2)
          Write-Host "[OK] Driver built successfully" -ForegroundColor Green
          Write-Host "    File: $sysFile" -ForegroundColor Cyan
          Write-Host "    Size: $size KB" -ForegroundColor Gray

          # Show INF file
          $infFile = "SimpleLidDriver.inf"
          if (Test-Path $infFile) {
            Copy-Item $infFile "ARM64\Release\" -Force
            Write-Host "    INF: Copied to output directory" -ForegroundColor Gray
          }
        } else {
          Write-Host "[ERROR] Driver file not found: $sysFile" -ForegroundColor Red

          # List output directory contents
          Write-Host ""
          Write-Host "Checking output directories..." -ForegroundColor Yellow
          if (Test-Path "ARM64") {
            Write-Host "ARM64 directory contents:" -ForegroundColor Cyan
            Get-ChildItem "ARM64" -Recurse -File | Select-Object FullName | ForEach-Object { Write-Host "  $($_.FullName)" }
          } else {
            Write-Host "ARM64 directory does not exist" -ForegroundColor Red
          }

          exit 1
        }

    - name: Upload Driver Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SimpleLidDriver-ARM64
        path: |
          SimpleLidDriver/ARM64/Release/SimpleLidDriver.sys
          SimpleLidDriver/ARM64/Release/SimpleLidDriver.inf
        retention-days: 90

    - name: Create Release Package
      shell: powershell
      run: |
        Write-Host "Creating release package..." -ForegroundColor Cyan

        cd SimpleLidDriver\ARM64\Release

        # Create zip package
        $packageName = "SimpleLidDriver-ARM64-$(Get-Date -Format 'yyyyMMdd').zip"
        Compress-Archive -Path SimpleLidDriver.sys, SimpleLidDriver.inf -DestinationPath $packageName

        Write-Host "[OK] Package created: $packageName" -ForegroundColor Green

        # Show package info
        $packagePath = Get-Item $packageName
        Write-Host "    Size: $([Math]::Round($packagePath.Length / 1KB, 2)) KB" -ForegroundColor Gray

        # Move to root for release
        Move-Item $packageName ..\..\..\

    - name: Upload Release Package
      uses: actions/upload-artifact@v4
      with:
        name: SimpleLidDriver-Release-Package
        path: SimpleLidDriver-ARM64-*.zip
        retention-days: 90
