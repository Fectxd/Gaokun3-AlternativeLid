name: Build ARM64 Driver

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Install Windows Driver Kit (WDK)
      shell: powershell
      run: |
        Write-Host "Installing WDK via Chocolatey..." -ForegroundColor Cyan

        # Install WDK using Chocolatey
        choco install windows-driver-kit -y --version=10.0.26100.1742

        Write-Host "WDK installation completed" -ForegroundColor Green

    - name: Verify WDK Installation
      shell: powershell
      run: |
        Write-Host "Verifying WDK installation..." -ForegroundColor Cyan

        $wdkPath = "C:\Program Files (x86)\Windows Kits\10"

        if (Test-Path "$wdkPath\Include") {
          $sdkVersions = Get-ChildItem "$wdkPath\Include" -Directory | Sort-Object Name -Descending
          if ($sdkVersions.Count -gt 0) {
            $latestSdk = $sdkVersions[0].Name
            Write-Host "Latest SDK version: $latestSdk" -ForegroundColor Green

            # Check for km headers
            $kmPath = "$wdkPath\Include\$latestSdk\km"
            if (Test-Path "$kmPath\ntddk.h") {
              Write-Host "[OK] ntddk.h found" -ForegroundColor Green
            } else {
              Write-Host "[WARN] ntddk.h not found, checking alternative paths..." -ForegroundColor Yellow

              # List available SDK versions
              Write-Host "Available SDK versions:" -ForegroundColor Cyan
              Get-ChildItem "$wdkPath\Include" -Directory | ForEach-Object { Write-Host "  - $($_.Name)" }
            }
          }
        } else {
          Write-Host "[ERROR] WDK Include directory not found" -ForegroundColor Red

          # Check if WDK exists at all
          if (Test-Path $wdkPath) {
            Write-Host "WDK directory exists, contents:" -ForegroundColor Yellow
            Get-ChildItem $wdkPath | Select-Object Name
          } else {
            Write-Host "WDK not installed at expected location" -ForegroundColor Red
          }

          exit 1
        }

    - name: Build ARM64 Driver
      shell: powershell
      run: |
        Write-Host "Building SimpleLidDriver for ARM64..." -ForegroundColor Cyan

        cd SimpleLidDriver

        # Find MSBuild using vswhere
        $vsWhere = "C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe"

        if (Test-Path $vsWhere) {
          $vsPath = & $vsWhere -latest -products * -requires Microsoft.Component.MSBuild -property installationPath
          $msbuild = Join-Path $vsPath "MSBuild\Current\Bin\MSBuild.exe"

          if (-not (Test-Path $msbuild)) {
            Write-Host "[ERROR] MSBuild not found at: $msbuild" -ForegroundColor Red
            exit 1
          }
        } else {
          Write-Host "[ERROR] vswhere.exe not found" -ForegroundColor Red
          exit 1
        }

        Write-Host "Using MSBuild: $msbuild" -ForegroundColor Gray

        # Build with detailed output for debugging
        & $msbuild SimpleLidDriver.vcxproj `
          /p:Configuration=Release `
          /p:Platform=ARM64 `
          /v:detailed

        if ($LASTEXITCODE -ne 0) {
          Write-Host ""
          Write-Host "[ERROR] Build failed with exit code: $LASTEXITCODE" -ForegroundColor Red
          exit $LASTEXITCODE
        }

        Write-Host ""
        Write-Host "[SUCCESS] Build completed!" -ForegroundColor Green

    - name: Verify Build Output
      shell: powershell
      run: |
        cd SimpleLidDriver

        $sysFile = "ARM64\Release\SimpleLidDriver.sys"

        if (Test-Path $sysFile) {
          $size = [Math]::Round((Get-Item $sysFile).Length / 1KB, 2)
          Write-Host "[OK] Driver built successfully" -ForegroundColor Green
          Write-Host "    File: $sysFile" -ForegroundColor Cyan
          Write-Host "    Size: $size KB" -ForegroundColor Gray
        } else {
          Write-Host "[ERROR] Driver file not found: $sysFile" -ForegroundColor Red

          # List output directory contents
          Write-Host "Checking output directories..." -ForegroundColor Yellow
          if (Test-Path "ARM64") {
            Get-ChildItem "ARM64" -Recurse | Select-Object FullName
          } else {
            Write-Host "ARM64 directory does not exist" -ForegroundColor Red
          }

          exit 1
        }

    - name: Upload Driver Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SimpleLidDriver-ARM64
        path: |
          SimpleLidDriver/ARM64/Release/SimpleLidDriver.sys
          SimpleLidDriver/ARM64/Release/SimpleLidDriver.inf
        retention-days: 90

    - name: Create Release Package
      shell: powershell
      run: |
        Write-Host "Creating release package..." -ForegroundColor Cyan

        cd SimpleLidDriver\ARM64\Release

        # Create zip package
        $packageName = "SimpleLidDriver-ARM64-$(Get-Date -Format 'yyyyMMdd').zip"
        Compress-Archive -Path SimpleLidDriver.sys, SimpleLidDriver.inf -DestinationPath $packageName

        Write-Host "Package created: $packageName" -ForegroundColor Green

        # Move to root for release
        Move-Item $packageName ..\..\..\

    - name: Upload Release Package
      uses: actions/upload-artifact@v4
      with:
        name: SimpleLidDriver-Release-Package
        path: SimpleLidDriver-ARM64-*.zip
        retention-days: 90
