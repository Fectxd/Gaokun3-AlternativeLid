name: Build ARM64 Driver

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    - name: Install WDK via Chocolatey
      shell: powershell
      run: |
        Write-Host "Installing WDK components..." -ForegroundColor Cyan

        # Try to install windowsdriverkit package
        choco install -y windowsdriverkit11 --allow-empty-checksums --ignore-checksums --force

        Write-Host "Installation step completed" -ForegroundColor Green

    - name: Check Available Tools
      shell: powershell
      run: |
        Write-Host "Checking available build environment..." -ForegroundColor Cyan
        Write-Host ""

        # Check Windows SDK (already installed on runner)
        $sdkPath = "C:\Program Files (x86)\Windows Kits\10"
        if (Test-Path $sdkPath) {
          Write-Host "[OK] Windows Kits found: $sdkPath" -ForegroundColor Green

          if (Test-Path "$sdkPath\Include") {
            Write-Host "Available SDK versions:" -ForegroundColor Cyan
            Get-ChildItem "$sdkPath\Include" -Directory | ForEach-Object {
              $hasKm = Test-Path (Join-Path $_.FullName "km")
              $marker = if ($hasKm) { " [KMDF]" } else { "" }
              Write-Host "  - $($_.Name)$marker" -ForegroundColor $(if ($hasKm) { "Green" } else { "Gray" })
            }
          }

          if (Test-Path "$sdkPath\Lib") {
            Write-Host "Checking libraries..." -ForegroundColor Cyan
            $libVersions = Get-ChildItem "$sdkPath\Lib" -Directory
            foreach ($ver in $libVersions) {
              $kmLib = Join-Path $ver.FullName "km\x64"
              $kmArm64 = Join-Path $ver.FullName "km\arm64"
              if (Test-Path $kmArm64) {
                Write-Host "  - $($ver.Name) has ARM64 kernel libs" -ForegroundColor Green
              }
            }
          }
        }

        Write-Host ""

        # Check for Visual Studio
        $vsWhere = "C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe"
        if (Test-Path $vsWhere) {
          $vsPath = & $vsWhere -latest -products * -property installationPath
          Write-Host "[OK] Visual Studio: $vsPath" -ForegroundColor Green

          # Check for ARM64 tools
          $vcTools = Get-ChildItem "$vsPath\VC\Tools\MSVC" -Directory -ErrorAction SilentlyContinue
          if ($vcTools) {
            $latest = $vcTools | Sort-Object Name -Descending | Select-Object -First 1
            $arm64Compiler = Join-Path $latest.FullName "bin\Hostx64\arm64\cl.exe"
            if (Test-Path $arm64Compiler) {
              Write-Host "[OK] ARM64 compiler available" -ForegroundColor Green
            } else {
              Write-Host "[WARN] ARM64 compiler not found" -ForegroundColor Yellow
            }
          }
        }

    - name: Build ARM64 Driver
      shell: powershell
      run: |
        Write-Host "Building SimpleLidDriver for ARM64..." -ForegroundColor Cyan
        Write-Host ""

        cd SimpleLidDriver

        # Find latest SDK version
        $sdkPath = "C:\Program Files (x86)\Windows Kits\10\Include"
        $sdkVersions = Get-ChildItem $sdkPath -Directory | Sort-Object Name -Descending
        $latestSdk = $sdkVersions[0].Name

        Write-Host "Using SDK version: $latestSdk" -ForegroundColor Gray

        # Build with explicit SDK version
        msbuild SimpleLidDriver.vcxproj `
          /p:Configuration=Release `
          /p:Platform=ARM64 `
          /p:WindowsTargetPlatformVersion=$latestSdk `
          /v:normal `
          /fl /flp:logfile=build.log

        if ($LASTEXITCODE -ne 0) {
          Write-Host ""
          Write-Host "[ERROR] Build failed!" -ForegroundColor Red
          Write-Host ""
          Write-Host "Build log:" -ForegroundColor Yellow
          if (Test-Path "build.log") {
            Get-Content "build.log" -Tail 50
          }
          exit 1
        }

        Write-Host ""
        Write-Host "[SUCCESS] Build completed!" -ForegroundColor Green

    - name: Verify Build Output
      shell: powershell
      run: |
        cd SimpleLidDriver

        $sysFile = "ARM64\Release\SimpleLidDriver.sys"

        if (Test-Path $sysFile) {
          $size = [Math]::Round((Get-Item $sysFile).Length / 1KB, 2)
          Write-Host "[OK] Driver built: $sysFile" -ForegroundColor Green
          Write-Host "    Size: $size KB" -ForegroundColor Gray

          # Copy INF
          Copy-Item "SimpleLidDriver.inf" "ARM64\Release\" -Force
          Write-Host "[OK] INF copied to output" -ForegroundColor Green
        } else {
          Write-Host "[ERROR] Driver file not found!" -ForegroundColor Red
          Write-Host ""

          # Show what was built
          Write-Host "Checking build output..." -ForegroundColor Yellow
          if (Test-Path "ARM64") {
            Get-ChildItem "ARM64" -Recurse -File | ForEach-Object {
              Write-Host "  $($_.FullName)" -ForegroundColor Gray
            }
          } else {
            Write-Host "ARM64 directory not created" -ForegroundColor Red
          }

          # Show build log
          if (Test-Path "build.log") {
            Write-Host ""
            Write-Host "Build log (last 100 lines):" -ForegroundColor Yellow
            Get-Content "build.log" -Tail 100
          }

          exit 1
        }

    - name: Upload Driver Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SimpleLidDriver-ARM64
        path: |
          SimpleLidDriver/ARM64/Release/SimpleLidDriver.sys
          SimpleLidDriver/ARM64/Release/SimpleLidDriver.inf
        retention-days: 90

    - name: Create Release Package
      shell: powershell
      run: |
        cd SimpleLidDriver\ARM64\Release

        $pkgName = "SimpleLidDriver-ARM64-$(Get-Date -Format 'yyyyMMdd').zip"
        Compress-Archive -Path SimpleLidDriver.sys, SimpleLidDriver.inf -DestinationPath $pkgName

        Write-Host "[OK] Package created: $pkgName" -ForegroundColor Green
        Write-Host "    Size: $([Math]::Round((Get-Item $pkgName).Length / 1KB, 2)) KB" -ForegroundColor Gray

        Move-Item $pkgName ..\..\..\

    - name: Upload Release Package
      uses: actions/upload-artifact@v4
      with:
        name: SimpleLidDriver-Release-Package
        path: SimpleLidDriver-ARM64-*.zip
        retention-days: 90
