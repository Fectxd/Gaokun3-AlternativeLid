name: Build ARM64 Driver

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    - name: Setup WDK
      uses: GuillaumeFalourd/setup-windows-wdk@v1
      with:
        wdk-version: '10.0.26100.1742'

    - name: Verify Installation
      shell: powershell
      run: |
        Write-Host "Verifying environment..." -ForegroundColor Cyan
        Write-Host ""

        # Check Windows Kits
        $wdkPath = "C:\Program Files (x86)\Windows Kits\10"
        if (Test-Path $wdkPath) {
          Write-Host "[OK] Windows Kits found" -ForegroundColor Green

          # List SDK versions
          if (Test-Path "$wdkPath\Include") {
            Write-Host "SDK versions:" -ForegroundColor Cyan
            Get-ChildItem "$wdkPath\Include" -Directory | ForEach-Object {
              $kmPath = Join-Path $_.FullName "km"
              if (Test-Path $kmPath) {
                Write-Host "  - $($_.Name) [has km]" -ForegroundColor Green
              } else {
                Write-Host "  - $($_.Name)" -ForegroundColor Gray
              }
            }
          }
        }

        Write-Host ""

        # Check MSBuild
        $msbuild = Get-Command msbuild -ErrorAction SilentlyContinue
        if ($msbuild) {
          Write-Host "[OK] MSBuild: $($msbuild.Source)" -ForegroundColor Green
        }

    - name: Build ARM64 Driver
      shell: powershell
      run: |
        Write-Host "Building SimpleLidDriver for ARM64..." -ForegroundColor Cyan
        Write-Host ""

        cd SimpleLidDriver

        # Build
        msbuild SimpleLidDriver.vcxproj `
          /p:Configuration=Release `
          /p:Platform=ARM64 `
          /v:minimal

        if ($LASTEXITCODE -ne 0) {
          Write-Host ""
          Write-Host "[ERROR] Build failed" -ForegroundColor Red
          exit $LASTEXITCODE
        }

        Write-Host ""
        Write-Host "[SUCCESS] Build completed!" -ForegroundColor Green

    - name: Verify Build Output
      shell: powershell
      run: |
        cd SimpleLidDriver

        $sysFile = "ARM64\Release\SimpleLidDriver.sys"

        if (Test-Path $sysFile) {
          $size = [Math]::Round((Get-Item $sysFile).Length / 1KB, 2)
          Write-Host "[OK] Driver: $sysFile ($size KB)" -ForegroundColor Green

          # Copy INF
          Copy-Item "SimpleLidDriver.inf" "ARM64\Release\" -Force
          Write-Host "[OK] INF copied" -ForegroundColor Green
        } else {
          Write-Host "[ERROR] Driver not found" -ForegroundColor Red

          # Debug
          if (Test-Path "ARM64") {
            Write-Host "Output files:" -ForegroundColor Yellow
            Get-ChildItem "ARM64" -Recurse -File | ForEach-Object {
              Write-Host "  $($_.FullName)" -ForegroundColor Gray
            }
          }

          exit 1
        }

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SimpleLidDriver-ARM64
        path: |
          SimpleLidDriver/ARM64/Release/SimpleLidDriver.sys
          SimpleLidDriver/ARM64/Release/SimpleLidDriver.inf
        retention-days: 90

    - name: Create Release Package
      shell: powershell
      run: |
        cd SimpleLidDriver\ARM64\Release

        $pkgName = "SimpleLidDriver-ARM64-$(Get-Date -Format 'yyyyMMdd').zip"
        Compress-Archive -Path SimpleLidDriver.sys, SimpleLidDriver.inf -DestinationPath $pkgName

        Write-Host "[OK] Package: $pkgName" -ForegroundColor Green

        Move-Item $pkgName ..\..\..\

    - name: Upload Release Package
      uses: actions/upload-artifact@v4
      with:
        name: SimpleLidDriver-Release-Package
        path: SimpleLidDriver-ARM64-*.zip
        retention-days: 90
