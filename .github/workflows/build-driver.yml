name: Build ARM64 Driver

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Install WDK using winget
      shell: powershell
      run: |
        Write-Host "Installing WDK using winget..." -ForegroundColor Cyan

        # Use winget to install WDK
        winget install --id Microsoft.WindowsWDK --version 10.0.26100.1 --silent --accept-package-agreements --accept-source-agreements

        if ($LASTEXITCODE -eq 0) {
          Write-Host "[OK] WDK installation completed" -ForegroundColor Green
        } else {
          Write-Host "[WARN] WDK installation returned exit code: $LASTEXITCODE" -ForegroundColor Yellow
          Write-Host "Continuing anyway..." -ForegroundColor Gray
        }

    - name: Verify WDK Installation
      shell: powershell
      run: |
        Write-Host "Verifying WDK installation..." -ForegroundColor Cyan
        Write-Host ""

        $wdkPath = "C:\Program Files (x86)\Windows Kits\10"

        # List Windows Kits directory
        Write-Host "Checking Windows Kits directory..." -ForegroundColor Yellow
        if (Test-Path $wdkPath) {
          Write-Host "Contents of Windows Kits\10:" -ForegroundColor Gray
          Get-ChildItem $wdkPath -Directory | ForEach-Object {
            Write-Host "  - $($_.Name)" -ForegroundColor Gray
          }
          Write-Host ""
        } else {
          Write-Host "[ERROR] Windows Kits directory not found" -ForegroundColor Red
          exit 1
        }

        # Check Include directory
        if (Test-Path "$wdkPath\Include") {
          $sdkVersions = Get-ChildItem "$wdkPath\Include" -Directory | Sort-Object Name -Descending

          if ($sdkVersions.Count -gt 0) {
            Write-Host "Available SDK versions:" -ForegroundColor Cyan

            $foundKm = $false
            foreach ($sdk in $sdkVersions) {
              Write-Host "  - $($sdk.Name)" -ForegroundColor Gray

              # Check for km directory
              $kmPath = Join-Path $sdk.FullName "km"
              if (Test-Path $kmPath) {
                Write-Host "    [OK] km directory exists" -ForegroundColor Green
                $foundKm = $true

                # Check for key headers
                if (Test-Path "$kmPath\ntddk.h") {
                  Write-Host "    [OK] ntddk.h found" -ForegroundColor Green
                }
                if (Test-Path "$kmPath\wdf.h") {
                  Write-Host "    [OK] wdf.h found" -ForegroundColor Green
                }
              } else {
                Write-Host "    [INFO] No km directory (user-mode SDK only)" -ForegroundColor Gray
              }
            }

            Write-Host ""
            if ($foundKm) {
              Write-Host "[OK] WDK kernel mode components are available" -ForegroundColor Green
            } else {
              Write-Host "[ERROR] No kernel mode SDK found - WDK may not be properly installed" -ForegroundColor Red
              exit 1
            }
          } else {
            Write-Host "[ERROR] No SDK versions found" -ForegroundColor Red
            exit 1
          }
        } else {
          Write-Host "[ERROR] Include directory not found" -ForegroundColor Red
          exit 1
        }

    - name: Check VS ARM64 Tools
      shell: powershell
      run: |
        Write-Host "Checking for ARM64 build tools..." -ForegroundColor Cyan

        # Find Visual Studio installation
        $vsWhere = "C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe"

        if (Test-Path $vsWhere) {
          $vsPath = & $vsWhere -latest -products * -property installationPath
          Write-Host "Visual Studio path: $vsPath" -ForegroundColor Gray

          # Check for ARM64 compiler
          $arm64Paths = @(
            "$vsPath\VC\Tools\MSVC\*\bin\Hostx64\arm64\cl.exe",
            "$vsPath\VC\Tools\MSVC\*\bin\Hostx86\arm64\cl.exe"
          )

          $found = $false
          foreach ($pattern in $arm64Paths) {
            $files = Get-ChildItem $pattern -ErrorAction SilentlyContinue
            if ($files) {
              Write-Host "[OK] ARM64 compiler found: $($files[0].DirectoryName)" -ForegroundColor Green
              $found = $true
              break
            }
          }

          if (-not $found) {
            Write-Host "[WARN] ARM64 compiler not found" -ForegroundColor Yellow
            Write-Host "Attempting to install ARM64 build tools..." -ForegroundColor Cyan

            # Install ARM64 workload
            & "$vsPath\Common7\IDE\VSIXInstaller.exe" /quiet /installVSIX
          }
        }

    - name: Build ARM64 Driver
      shell: powershell
      run: |
        Write-Host "Building SimpleLidDriver for ARM64..." -ForegroundColor Cyan
        Write-Host ""

        cd SimpleLidDriver

        # Find MSBuild
        $vsWhere = "C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe"
        $vsPath = & $vsWhere -latest -products * -requires Microsoft.Component.MSBuild -property installationPath
        $msbuild = Join-Path $vsPath "MSBuild\Current\Bin\MSBuild.exe"

        if (-not (Test-Path $msbuild)) {
          Write-Host "[ERROR] MSBuild not found" -ForegroundColor Red
          exit 1
        }

        Write-Host "Using MSBuild: $msbuild" -ForegroundColor Gray
        Write-Host ""

        # Build
        & $msbuild SimpleLidDriver.vcxproj `
          /p:Configuration=Release `
          /p:Platform=ARM64 `
          /v:normal

        if ($LASTEXITCODE -ne 0) {
          Write-Host ""
          Write-Host "[ERROR] Build failed with exit code: $LASTEXITCODE" -ForegroundColor Red
          exit $LASTEXITCODE
        }

        Write-Host ""
        Write-Host "[SUCCESS] Build completed!" -ForegroundColor Green

    - name: Verify Build Output
      shell: powershell
      run: |
        cd SimpleLidDriver

        $sysFile = "ARM64\Release\SimpleLidDriver.sys"

        if (Test-Path $sysFile) {
          $size = [Math]::Round((Get-Item $sysFile).Length / 1KB, 2)
          Write-Host "[OK] Driver built successfully" -ForegroundColor Green
          Write-Host "    File: $sysFile" -ForegroundColor Cyan
          Write-Host "    Size: $size KB" -ForegroundColor Gray

          # Copy INF
          Copy-Item "SimpleLidDriver.inf" "ARM64\Release\" -Force
          Write-Host "    INF: Copied to output" -ForegroundColor Gray
        } else {
          Write-Host "[ERROR] Driver file not found" -ForegroundColor Red

          # Debug: List all output
          Write-Host ""
          Write-Host "Output directory contents:" -ForegroundColor Yellow
          if (Test-Path "ARM64") {
            Get-ChildItem "ARM64" -Recurse -File | ForEach-Object {
              Write-Host "  $($_.FullName)" -ForegroundColor Gray
            }
          }

          exit 1
        }

    - name: Upload Driver Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SimpleLidDriver-ARM64
        path: |
          SimpleLidDriver/ARM64/Release/SimpleLidDriver.sys
          SimpleLidDriver/ARM64/Release/SimpleLidDriver.inf
        retention-days: 90

    - name: Create Release Package
      shell: powershell
      run: |
        Write-Host "Creating release package..." -ForegroundColor Cyan

        cd SimpleLidDriver\ARM64\Release

        $packageName = "SimpleLidDriver-ARM64-$(Get-Date -Format 'yyyyMMdd').zip"
        Compress-Archive -Path SimpleLidDriver.sys, SimpleLidDriver.inf -DestinationPath $packageName

        Write-Host "[OK] Package: $packageName" -ForegroundColor Green
        Write-Host "    Size: $([Math]::Round((Get-Item $packageName).Length / 1KB, 2)) KB" -ForegroundColor Gray

        Move-Item $packageName ..\..\..\

    - name: Upload Release Package
      uses: actions/upload-artifact@v4
      with:
        name: SimpleLidDriver-Release-Package
        path: SimpleLidDriver-ARM64-*.zip
        retention-days: 90
